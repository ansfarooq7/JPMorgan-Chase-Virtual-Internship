{"version":3,"sources":["../../src/js/perspective.parallel.js"],"names":["defaults","get_config","Client","WebSocketClient","require","wasm_worker","wasm","override_config","INLINE_WARNING","override","_fetch","url","Promise","resolve","wasmXHR","XMLHttpRequest","open","responseType","onload","response","send","worker","ArrayBuffer","console","warn","_wasm","WebWorkerClient","constructor","config","register","_worker","msg","cmd","WebAssembly","Error","buffer","all","key","addEventListener","_handle","bind","postMessage","_detect_transferable","transferable","args","terminate","undefined","ab","byteLength","log","WORKER_SINGLETON","__WORKER__","__CONFIG__","getInstance","config_str","JSON","stringify","document","currentScript","hasAttribute","mod","x","set","websocket","window","location","origin","replace","WebSocket","shared_worker","prop","Object","keys"],"mappings":"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","sourcesContent":["/******************************************************************************\n *\n * Copyright (c) 2017, the Perspective Authors.\n *\n * This file is part of the Perspective library, distributed under the terms of\n * the Apache License 2.0.  The full license can be found in the LICENSE file.\n *\n */\n\nimport * as defaults from \"./config/constants.js\";\nimport {get_config} from \"./config\";\nimport {Client} from \"./api/client.js\";\nconst {WebSocketClient} = require(\"./websocket\");\n\nimport wasm_worker from \"./perspective.wasm.js\";\nimport wasm from \"./psp.async.wasm.js\";\nimport {override_config} from \"../../dist/esm/config/index.js\";\n\n// eslint-disable-next-line max-len\nconst INLINE_WARNING = `Perspective has been compiled in INLINE mode.  While Perspective's runtime performance is not affected, you may see smaller assets size and faster engine initial load time using \"@finos/perspective-webpack-plugin\" to build your application.\n\nhttps://perspective.finos.org/docs/md/installation.html#-an-important-note-about-hosting`;\n\n/**\n * Singleton WASM file download cache.\n */\nconst override = new (class {\n    _fetch(url) {\n        return new Promise(resolve => {\n            let wasmXHR = new XMLHttpRequest();\n            wasmXHR.open(\"GET\", url, true);\n            wasmXHR.responseType = \"arraybuffer\";\n            wasmXHR.onload = () => {\n                resolve(wasmXHR.response);\n            };\n            wasmXHR.send(null);\n        });\n    }\n\n    worker() {\n        return wasm_worker();\n    }\n\n    async wasm() {\n        if (wasm instanceof ArrayBuffer) {\n            console.warn(INLINE_WARNING);\n            this._wasm = wasm;\n        } else {\n            this._wasm = await this._fetch(wasm);\n        }\n        return this._wasm;\n    }\n})();\n\n/**\n * WebWorker extends Perspective's `worker` class and defines interactions using\n * the WebWorker API.\n *\n * This class serves as the client API for transporting messages to/from Web\n * Workers.\n */\nclass WebWorkerClient extends Client {\n    constructor(config) {\n        if (config) {\n            override_config(config);\n        }\n        super();\n        this.register();\n    }\n\n    /**\n     * When the worker is created, load either the ASM or WASM bundle depending\n     * on WebAssembly compatibility.  Don't use transferrable so multiple\n     * workers can be instantiated.\n     */\n    async register() {\n        let _worker;\n        const msg = {cmd: \"init\", config: get_config()};\n        if (typeof WebAssembly === \"undefined\") {\n            throw new Error(\"WebAssembly not supported. Support for ASM.JS has been removed as of 0.3.1.\");\n        } else {\n            [_worker, msg.buffer] = await Promise.all([override.worker(), override.wasm()]);\n        }\n        for (var key in this._worker) {\n            _worker[key] = this._worker[key];\n        }\n        this._worker = _worker;\n        this._worker.addEventListener(\"message\", this._handle.bind(this));\n        this._worker.postMessage(msg);\n        this._detect_transferable();\n    }\n\n    /**\n     * Send a message from the worker, using transferables if necessary.\n     *\n     * @param {*} msg\n     */\n    send(msg) {\n        if (this._worker.transferable && msg.args && msg.args[0] instanceof ArrayBuffer) {\n            this._worker.postMessage(msg, msg.args[0]);\n        } else {\n            this._worker.postMessage(msg);\n        }\n    }\n\n    terminate() {\n        this._worker.terminate();\n        this._worker = undefined;\n    }\n\n    _detect_transferable() {\n        var ab = new ArrayBuffer(1);\n        this._worker.postMessage(ab, [ab]);\n        this._worker.transferable = ab.byteLength === 0;\n        if (!this._worker.transferable) {\n            console.warn(\"Transferable support not detected\");\n        } else {\n            console.log(\"Transferable support detected\");\n        }\n    }\n}\n\n/******************************************************************************\n *\n * Web Worker Singleton\n *\n */\n\nconst WORKER_SINGLETON = (function() {\n    let __WORKER__, __CONFIG__;\n    return {\n        getInstance: function(config) {\n            if (__WORKER__ === undefined) {\n                __WORKER__ = new WebWorkerClient(config);\n            }\n            const config_str = JSON.stringify(config);\n            if (__CONFIG__ && config_str !== __CONFIG__) {\n                throw new Error(`Confiuration object for shared_worker() has changed - this is probably a bug in your application.`);\n            }\n            __CONFIG__ = config_str;\n            return __WORKER__;\n        }\n    };\n})();\n\n/**\n * If Perspective is loaded with the `preload` attribute, pre-initialize the\n * worker so it is available at page render.\n */\nif (document.currentScript && document.currentScript.hasAttribute(\"preload\")) {\n    WORKER_SINGLETON.getInstance();\n}\n\nconst mod = {\n    override: x => override.set(x),\n\n    /**\n     * Create a new WebWorkerClient instance. s\n     * @param {*} [config] An optional perspective config object override\n     */\n    worker(config) {\n        return new WebWorkerClient(config);\n    },\n\n    /**\n     * Create a new WebSocketClient instance. The `url` parameter is provided,\n     * load the worker at `url` using a WebSocket. s\n     * @param {*} url Defaults to `window.location.origin`\n     * @param {*} [config] An optional perspective config object override\n     */\n    websocket(url = window.location.origin.replace(\"http\", \"ws\")) {\n        return new WebSocketClient(new WebSocket(url));\n    },\n\n    shared_worker(config) {\n        return WORKER_SINGLETON.getInstance(config);\n    }\n};\n\nfor (let prop of Object.keys(defaults)) {\n    mod[prop] = defaults[prop];\n}\n\nexport default mod;\n"],"file":"perspective.parallel.js"}