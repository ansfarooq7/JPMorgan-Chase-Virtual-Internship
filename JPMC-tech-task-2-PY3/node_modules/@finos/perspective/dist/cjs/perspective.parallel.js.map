{"version":3,"sources":["../../src/js/perspective.parallel.js"],"names":["WebSocketClient","require","INLINE_WARNING","override","_fetch","resolve","wasmXHR","worker","wasm","console","constructor","override_config","msg","cmd","config","get_config","Promise","_worker","send","terminate","_detect_transferable","ab","WORKER_SINGLETON","getInstance","__WORKER__","config_str","JSON","__CONFIG__","document","mod","x","websocket","url","window","shared_worker","Object","defaults"],"mappings":";;;;;;;;;;;;;;;AASA;;AACA;;AACA;;AAGA;;AACA;;AACA;;;;;;;;AAhBA;;;;;;;;AAYA,MAAM;AAACA,EAAAA;AAAD,IAAoBC,OAAO,CAAjC,aAAiC,CAAjC;;AAMA;AACA,MAAMC,cAAc,GAAI;;yFAAxB;AAIA;;;;AAGA,MAAMC,QAAQ,GAAG,IAAK,MAAM;AACxBC,EAAAA,MAAM,CAAA,GAAA,EAAM;AACR,WAAO,IAAA,OAAA,CAAYC,OAAO,IAAI;AAC1B,UAAIC,OAAO,GAAG,IAAd,cAAc,EAAd;AACAA,MAAAA,OAAO,CAAPA,IAAAA,CAAAA,KAAAA,EAAAA,GAAAA,EAAAA,IAAAA;AACAA,MAAAA,OAAO,CAAPA,YAAAA,GAAAA,aAAAA;;AACAA,MAAAA,OAAO,CAAPA,MAAAA,GAAiB,MAAM;AACnBD,QAAAA,OAAO,CAACC,OAAO,CAAfD,QAAO,CAAPA;AADJC,OAAAA;;AAGAA,MAAAA,OAAO,CAAPA,IAAAA,CAAAA,IAAAA;AAPJ,KAAO,CAAP;AASH;;AAEDC,EAAAA,MAAM,GAAG;AACL,WAAA,+BAAA;AACH;;AAED,QAAA,IAAA,GAAa;AACT,QAAIC,iCAAJ,WAAA,EAAiC;AAC7BC,MAAAA,OAAO,CAAPA,IAAAA,CAAAA,cAAAA;AACA,WAAA,KAAA,GAAA,qBAAA;AAFJ,KAAA,MAGO;AACH,WAAA,KAAA,GAAa,MAAM,KAAA,MAAA,CAAnB,qBAAmB,CAAnB;AACH;;AACD,WAAO,KAAP,KAAA;AACH;;AAzBuB,CAAX,EAAjB;AA4BA;;;;;;;;AAOA,MAAA,eAAA,SAAA,cAAA,CAAqC;AACjCC,EAAAA,WAAW,CAAA,MAAA,EAAS;AAChB,QAAA,MAAA,EAAY;AACRC,kCAAAA,MAAAA;AACH;;AACD;AACA,SAAA,QAAA;AACH;AAED;;;;;;;AAKA,QAAA,QAAA,GAAiB;AACb,QAAA,OAAA;;AACA,UAAMC,GAAG,GAAG;AAACC,MAAAA,GAAG,EAAJ,MAAA;AAAcC,MAAAA,MAAM,EAAEC;AAAtB,KAAZ;;AACA,QAAI,OAAA,WAAA,KAAJ,WAAA,EAAwC;AACpC,YAAM,IAAA,KAAA,CAAN,6EAAM,CAAN;AADJ,KAAA,MAEO;AACH,OAAA,OAAA,EAAUH,GAAG,CAAb,MAAA,IAAwB,MAAMI,OAAO,CAAPA,GAAAA,CAAY,CAACb,QAAQ,CAAT,MAACA,EAAD,EAAoBA,QAAQ,CAAtE,IAA8DA,EAApB,CAAZa,CAA9B;AACH;;AACD,SAAK,IAAL,GAAA,IAAgB,KAAhB,OAAA,EAA8B;AAC1BC,MAAAA,OAAO,CAAPA,GAAO,CAAPA,GAAe,KAAA,OAAA,CAAfA,GAAe,CAAfA;AACH;;AACD,SAAA,OAAA,GAAA,OAAA;;AACA,SAAA,OAAA,CAAA,gBAAA,CAAA,SAAA,EAAyC,KAAA,OAAA,CAAA,IAAA,CAAzC,IAAyC,CAAzC;;AACA,SAAA,OAAA,CAAA,WAAA,CAAA,GAAA;;AACA,SAAA,oBAAA;AACH;AAED;;;;;;;AAKAC,EAAAA,IAAI,CAAA,GAAA,EAAM;AACN,QAAI,KAAA,OAAA,CAAA,YAAA,IAA6BN,GAAG,CAAhC,IAAA,IAAyCA,GAAG,CAAHA,IAAAA,CAAAA,CAAAA,aAA7C,WAAA,EAAiF;AAC7E,WAAA,OAAA,CAAA,WAAA,CAAA,GAAA,EAA8BA,GAAG,CAAHA,IAAAA,CAA9B,CAA8BA,CAA9B;AADJ,KAAA,MAEO;AACH,WAAA,OAAA,CAAA,WAAA,CAAA,GAAA;AACH;AACJ;;AAEDO,EAAAA,SAAS,GAAG;AACR,SAAA,OAAA,CAAA,SAAA;;AACA,SAAA,OAAA,GAAA,SAAA;AACH;;AAEDC,EAAAA,oBAAoB,GAAG;AACnB,QAAIC,EAAE,GAAG,IAAA,WAAA,CAAT,CAAS,CAAT;;AACA,SAAA,OAAA,CAAA,WAAA,CAAA,EAAA,EAA6B,CAA7B,EAA6B,CAA7B;;AACA,SAAA,OAAA,CAAA,YAAA,GAA4BA,EAAE,CAAFA,UAAAA,KAA5B,CAAA;;AACA,QAAI,CAAC,KAAA,OAAA,CAAL,YAAA,EAAgC;AAC5BZ,MAAAA,OAAO,CAAPA,IAAAA,CAAAA,mCAAAA;AADJ,KAAA,MAEO;AACHA,MAAAA,OAAO,CAAPA,GAAAA,CAAAA,+BAAAA;AACH;AACJ;;AA1DgC;AA6DrC;;;;;;;AAMA,MAAMa,gBAAgB,GAAI,YAAW;AACjC,MAAA,UAAA,EAAA,UAAA;;AACA,SAAO;AACHC,IAAAA,WAAW,EAAE,UAAA,MAAA,EAAiB;AAC1B,UAAIC,UAAU,KAAd,SAAA,EAA8B;AAC1BA,QAAAA,UAAU,GAAG,IAAA,eAAA,CAAbA,MAAa,CAAbA;AACH;;AACD,YAAMC,UAAU,GAAGC,IAAI,CAAJA,SAAAA,CAAnB,MAAmBA,CAAnB;;AACA,UAAIC,UAAU,IAAIF,UAAU,KAA5B,UAAA,EAA6C;AACzC,cAAM,IAAA,KAAA,CAAN,mGAAM,CAAN;AACH;;AACDE,MAAAA,UAAU,GAAVA,UAAAA;AACA,aAAA,UAAA;AACH;AAXE,GAAP;AAFJ,CAA0B,EAA1B;AAiBA;;;;;;AAIA,IAAIC,QAAQ,CAARA,aAAAA,IAA0BA,QAAQ,CAARA,aAAAA,CAAAA,YAAAA,CAA9B,SAA8BA,CAA9B,EAA8E;AAC1EN,EAAAA,gBAAgB,CAAhBA,WAAAA;AACH;;AAED,MAAMO,GAAG,GAAG;AACR1B,EAAAA,QAAQ,EAAE2B,CAAC,IAAI3B,QAAQ,CAARA,GAAAA,CADP,CACOA,CADP;;AAGR;;;;AAIAI,EAAAA,MAAM,CAAA,MAAA,EAAS;AACX,WAAO,IAAA,eAAA,CAAP,MAAO,CAAP;AARI,GAAA;;AAWR;;;;;;AAMAwB,EAAAA,SAAS,CAACC,GAAG,GAAGC,MAAM,CAANA,QAAAA,CAAAA,MAAAA,CAAAA,OAAAA,CAAAA,MAAAA,EAAP,IAAOA,CAAP,EAAqD;AAC1D,WAAO,IAAA,eAAA,CAAoB,IAAA,SAAA,CAA3B,GAA2B,CAApB,CAAP;AAlBI,GAAA;;AAqBRC,EAAAA,aAAa,CAAA,MAAA,EAAS;AAClB,WAAOZ,gBAAgB,CAAhBA,WAAAA,CAAP,MAAOA,CAAP;AACH;;AAvBO,CAAZ;;AA0BA,KAAK,IAAL,IAAA,IAAiBa,MAAM,CAANA,IAAAA,CAAjB,QAAiBA,CAAjB,EAAwC;AACpCN,EAAAA,GAAG,CAAHA,IAAG,CAAHA,GAAYO,QAAQ,CAApBP,IAAoB,CAApBA;AACH;;eAED,G","sourcesContent":["/******************************************************************************\n *\n * Copyright (c) 2017, the Perspective Authors.\n *\n * This file is part of the Perspective library, distributed under the terms of\n * the Apache License 2.0.  The full license can be found in the LICENSE file.\n *\n */\n\nimport * as defaults from \"./config/constants.js\";\nimport {get_config} from \"./config\";\nimport {Client} from \"./api/client.js\";\nconst {WebSocketClient} = require(\"./websocket\");\n\nimport wasm_worker from \"./perspective.wasm.js\";\nimport wasm from \"./psp.async.wasm.js\";\nimport {override_config} from \"../../dist/esm/config/index.js\";\n\n// eslint-disable-next-line max-len\nconst INLINE_WARNING = `Perspective has been compiled in INLINE mode.  While Perspective's runtime performance is not affected, you may see smaller assets size and faster engine initial load time using \"@finos/perspective-webpack-plugin\" to build your application.\n\nhttps://perspective.finos.org/docs/md/installation.html#-an-important-note-about-hosting`;\n\n/**\n * Singleton WASM file download cache.\n */\nconst override = new (class {\n    _fetch(url) {\n        return new Promise(resolve => {\n            let wasmXHR = new XMLHttpRequest();\n            wasmXHR.open(\"GET\", url, true);\n            wasmXHR.responseType = \"arraybuffer\";\n            wasmXHR.onload = () => {\n                resolve(wasmXHR.response);\n            };\n            wasmXHR.send(null);\n        });\n    }\n\n    worker() {\n        return wasm_worker();\n    }\n\n    async wasm() {\n        if (wasm instanceof ArrayBuffer) {\n            console.warn(INLINE_WARNING);\n            this._wasm = wasm;\n        } else {\n            this._wasm = await this._fetch(wasm);\n        }\n        return this._wasm;\n    }\n})();\n\n/**\n * WebWorker extends Perspective's `worker` class and defines interactions using\n * the WebWorker API.\n *\n * This class serves as the client API for transporting messages to/from Web\n * Workers.\n */\nclass WebWorkerClient extends Client {\n    constructor(config) {\n        if (config) {\n            override_config(config);\n        }\n        super();\n        this.register();\n    }\n\n    /**\n     * When the worker is created, load either the ASM or WASM bundle depending\n     * on WebAssembly compatibility.  Don't use transferrable so multiple\n     * workers can be instantiated.\n     */\n    async register() {\n        let _worker;\n        const msg = {cmd: \"init\", config: get_config()};\n        if (typeof WebAssembly === \"undefined\") {\n            throw new Error(\"WebAssembly not supported. Support for ASM.JS has been removed as of 0.3.1.\");\n        } else {\n            [_worker, msg.buffer] = await Promise.all([override.worker(), override.wasm()]);\n        }\n        for (var key in this._worker) {\n            _worker[key] = this._worker[key];\n        }\n        this._worker = _worker;\n        this._worker.addEventListener(\"message\", this._handle.bind(this));\n        this._worker.postMessage(msg);\n        this._detect_transferable();\n    }\n\n    /**\n     * Send a message from the worker, using transferables if necessary.\n     *\n     * @param {*} msg\n     */\n    send(msg) {\n        if (this._worker.transferable && msg.args && msg.args[0] instanceof ArrayBuffer) {\n            this._worker.postMessage(msg, msg.args[0]);\n        } else {\n            this._worker.postMessage(msg);\n        }\n    }\n\n    terminate() {\n        this._worker.terminate();\n        this._worker = undefined;\n    }\n\n    _detect_transferable() {\n        var ab = new ArrayBuffer(1);\n        this._worker.postMessage(ab, [ab]);\n        this._worker.transferable = ab.byteLength === 0;\n        if (!this._worker.transferable) {\n            console.warn(\"Transferable support not detected\");\n        } else {\n            console.log(\"Transferable support detected\");\n        }\n    }\n}\n\n/******************************************************************************\n *\n * Web Worker Singleton\n *\n */\n\nconst WORKER_SINGLETON = (function() {\n    let __WORKER__, __CONFIG__;\n    return {\n        getInstance: function(config) {\n            if (__WORKER__ === undefined) {\n                __WORKER__ = new WebWorkerClient(config);\n            }\n            const config_str = JSON.stringify(config);\n            if (__CONFIG__ && config_str !== __CONFIG__) {\n                throw new Error(`Confiuration object for shared_worker() has changed - this is probably a bug in your application.`);\n            }\n            __CONFIG__ = config_str;\n            return __WORKER__;\n        }\n    };\n})();\n\n/**\n * If Perspective is loaded with the `preload` attribute, pre-initialize the\n * worker so it is available at page render.\n */\nif (document.currentScript && document.currentScript.hasAttribute(\"preload\")) {\n    WORKER_SINGLETON.getInstance();\n}\n\nconst mod = {\n    override: x => override.set(x),\n\n    /**\n     * Create a new WebWorkerClient instance. s\n     * @param {*} [config] An optional perspective config object override\n     */\n    worker(config) {\n        return new WebWorkerClient(config);\n    },\n\n    /**\n     * Create a new WebSocketClient instance. The `url` parameter is provided,\n     * load the worker at `url` using a WebSocket. s\n     * @param {*} url Defaults to `window.location.origin`\n     * @param {*} [config] An optional perspective config object override\n     */\n    websocket(url = window.location.origin.replace(\"http\", \"ws\")) {\n        return new WebSocketClient(new WebSocket(url));\n    },\n\n    shared_worker(config) {\n        return WORKER_SINGLETON.getInstance(config);\n    }\n};\n\nfor (let prop of Object.keys(defaults)) {\n    mod[prop] = defaults[prop];\n}\n\nexport default mod;\n"],"file":"perspective.parallel.js"}