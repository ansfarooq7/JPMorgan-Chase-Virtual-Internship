{"version":3,"sources":["../../src/js/perspective.node.js"],"names":["Client","require","Server","WebSocketClient","perspective","fs","http","WebSocket","process","path","load_perspective","LOCAL_PATH","buffer","SYNC_SERVER","init","wasmBinary","wasmJSMethod","core","post","SYNC_CLIENT","data","msg","send","id","cmd","module","DEFAULT_ASSETS","CONTENT_TYPES","error","reject","resolve","response","url","request","extname","contentType","filePath","rootDir","content","read_promise","console","host_psp","paths","assets","x","constructor","on_start","port","perspective_assets","noServer","perMessageDeflate","ws","sock","close","websocket"],"mappings":"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","sourcesContent":["/******************************************************************************\n *\n * Copyright (c) 2017, the Perspective Authors.\n *\n * This file is part of the Perspective library, distributed under the terms of\n * the Apache License 2.0.  The full license can be found in the LICENSE file.\n *\n */\n\nconst {Client} = require(\"./api/client.js\");\nconst {Server} = require(\"./api/server.js\");\nconst {WebSocketManager, WebSocketClient} = require(\"./websocket\");\n\nconst perspective = require(\"./perspective.js\").default;\n\nconst fs = require(\"fs\");\nconst http = require(\"http\");\nconst WebSocket = require(\"ws\");\nconst process = require(\"process\");\n\nconst path = require(\"path\");\n\nconst load_perspective = require(\"./psp.async.js\").default;\n\n// eslint-disable-next-line no-undef\n\nconst LOCAL_PATH = path.join(process.cwd(), \"node_modules\");\nconst buffer = require(\"./psp.async.wasm.js\").default;\n\nconst SYNC_SERVER = new (class extends Server {\n    init(msg) {\n        load_perspective({\n            wasmBinary: buffer,\n            wasmJSMethod: \"native-wasm\"\n        }).then(core => {\n            this.perspective = perspective(core);\n            super.init(msg);\n        });\n    }\n\n    post(msg) {\n        SYNC_CLIENT._handle({data: msg});\n    }\n})();\n\nconst SYNC_CLIENT = new (class extends Client {\n    send(msg) {\n        SYNC_SERVER.process(msg);\n    }\n})();\n\nSYNC_CLIENT.send({id: -1, cmd: \"init\"});\n\nmodule.exports = SYNC_CLIENT;\nmodule.exports.sync_module = () => SYNC_SERVER.perspective;\n\nconst DEFAULT_ASSETS = [\n    \"@finos/perspective/dist/umd\",\n    \"@finos/perspective-bench/dist\",\n    \"@finos/perspective-viewer/dist/umd\",\n    \"@finos/perspective-viewer-highcharts/dist/umd\",\n    \"@finos/perspective-viewer-hypergrid/dist/umd\",\n    \"@finos/perspective-viewer-datagrid/dist/umd\",\n    \"@finos/perspective-viewer-d3fc/dist/umd\",\n    \"@finos/perspective-workspace/dist/umd\"\n];\n\nconst CONTENT_TYPES = {\n    \".js\": \"text/javascript\",\n    \".css\": \"text/css\",\n    \".json\": \"application/json\",\n    \".arrow\": \"arraybuffer\",\n    \".wasm\": \"application/wasm\"\n};\n\nfunction read_promise(filePath) {\n    return new Promise((resolve, reject) => {\n        fs.readFile(filePath, function(error, content) {\n            if (error && error.code !== \"ENOENT\") {\n                reject(error);\n            } else {\n                resolve(content);\n            }\n        });\n    });\n}\n\n/**\n * Host a Perspective server that hosts data, code files, etc.\n */\nfunction perspective_assets(assets, host_psp) {\n    return async function(request, response) {\n        response.setHeader(\"Access-Control-Allow-Origin\", \"*\");\n        response.setHeader(\"Access-Control-Request-Method\", \"*\");\n        response.setHeader(\"Access-Control-Allow-Methods\", \"OPTIONS,GET\");\n        response.setHeader(\"Access-Control-Allow-Headers\", \"*\");\n        let url = request.url.split(/[\\?\\#]/)[0];\n        if (url === \"/\") {\n            url = \"/index.html\";\n        }\n        let extname = path.extname(url);\n        let contentType = CONTENT_TYPES[extname] || \"text/html\";\n        try {\n            for (let rootDir of assets) {\n                let filePath = rootDir + url;\n                let content = await read_promise(filePath);\n                if (typeof content !== \"undefined\") {\n                    console.log(`200 ${url}`);\n                    response.writeHead(200, {\"Content-Type\": contentType});\n                    response.end(content, extname === \".arrow\" ? \"user-defined\" : \"utf-8\");\n                    return;\n                }\n            }\n            if (host_psp || typeof host_psp === \"undefined\") {\n                for (let rootDir of DEFAULT_ASSETS) {\n                    try {\n                        let paths = require.resolve.paths(rootDir + url);\n                        paths = [...paths, ...assets.map(x => path.join(x, \"node_modules\")), LOCAL_PATH];\n                        let filePath = require.resolve(rootDir + url, {paths});\n                        let content = await read_promise(filePath);\n                        if (typeof content !== \"undefined\") {\n                            console.log(`200 ${url}`);\n                            response.writeHead(200, {\"Content-Type\": contentType});\n                            response.end(content, extname === \".arrow\" ? \"user-defined\" : \"utf-8\");\n                            return;\n                        }\n                    } catch (e) {}\n                }\n            }\n            if (url.indexOf(\"favicon.ico\") > -1) {\n                response.writeHead(200);\n                response.end(\"\", \"utf-8\");\n            } else {\n                console.error(`404 ${url}`);\n                response.writeHead(404);\n                response.end(\"\", \"utf-8\");\n            }\n        } catch (error) {\n            if (error.code !== \"ENOENT\") {\n                console.error(`500 ${url}`);\n                response.writeHead(500);\n                response.end(\"\", \"utf-8\");\n            }\n        }\n    };\n}\n\nclass WebSocketServer extends WebSocketManager {\n    constructor({assets, host_psp, port, on_start} = {}) {\n        super();\n        port = typeof port === \"undefined\" ? 8080 : port;\n        assets = assets || [\"./\"];\n\n        // Serve Perspective files through HTTP\n        this._server = http.createServer(perspective_assets(assets, host_psp));\n\n        // Serve Worker API through WebSockets\n        this._wss = new WebSocket.Server({noServer: true, perMessageDeflate: true});\n\n        // When the server starts, define how to handle messages\n        this._wss.on(\"connection\", ws => this.add_connection(ws));\n\n        this._server.on(\"upgrade\", (request, socket, head) => {\n            console.log(\"200    *** websocket upgrade ***\");\n            this._wss.handleUpgrade(request, socket, head, sock => this._wss.emit(\"connection\", sock, request));\n        });\n\n        this._server.listen(port, () => {\n            console.log(`Listening on port ${this._server.address().port}`);\n            if (on_start) {\n                on_start();\n            }\n        });\n    }\n\n    close() {\n        this._server.close();\n    }\n}\n\nconst websocket = url => {\n    return new WebSocketClient(new WebSocket(url));\n};\n\nmodule.exports.websocket = websocket;\nmodule.exports.perspective_assets = perspective_assets;\nmodule.exports.WebSocketServer = WebSocketServer;\nmodule.exports.WebSocketManager = WebSocketManager;\n"],"file":"perspective.node.js"}